# 発注請書（注文請書）管理機能仕様書

## 1. 概要
発注請書（注文請書）管理機能は、外部業者から受け取る注文請書を管理するための機能です。発注書管理機能と同様の基本構造を持ちながら、注文請書特有の情報管理に対応します。

注文請書とは、発注者からの発注に対して、受注者が注文内容を承諾したことを示す書類です。本システムでは、自社が発注した内容に対して受け取る注文請書を管理します。

## 2. 機能要件

### 2.1 基本機能
- 発注請書の作成・編集・削除
- 発注請書の一覧表示・検索
- 発注請書のPDF出力・ダウンロード
- 発注請書の複製
- 発注書から発注請書への変換

### 2.2 発注請書のステータス管理
- **下書き (draft)**: 作成中の発注請書
- **送付済み (sent)**: 業者へ送付済み

### 2.3 権限管理
- 全ユーザーが全ての発注請書を閲覧可能
- 作成者のみが編集・削除可能（下書きステータスのみ）
- 管理者は全ての発注請書を編集・削除可能

## 3. データ構造

### 3.1 発注請書テーブル (OrderConfirmation)
| フィールド名 | 型 | 必須 | 説明 |
|------------|---|-----|------|
| id | String (UUID) | ✓ | 主キー |
| confirmationNumber | String | ✓ | 発注請書番号（YYYY-MM-NNN形式、例: 2025-01-001） |
| supplierId | String | ✓ | 発注先業者ID（Customerテーブルを参照） |
| honorific | String | | 敬称（御中、様など） |
| subject | String | ✓ | 件名 |
| issueDate | DateTime | ✓ | 発行日 |
| deliveryDate | DateTime | | 納期 |
| completionPeriod | String | | 検収完了期間 |
| paymentTerms | String | | お支払い条件 |
| userId | String | ✓ | 作成者ID |
| taxType | String | ✓ | 税計算方式（inclusive/exclusive） |
| taxRate | Int | ✓ | 税率（%） |
| roundingType | String | ✓ | 端数処理（floor/ceil/round） |
| subtotal | Decimal | ✓ | 小計 |
| taxAmount | Decimal | ✓ | 消費税額 |
| taxAmount8 | Decimal | | 8%消費税額 |
| taxAmount10 | Decimal | | 10%消費税額 |
| totalAmount | Decimal | ✓ | 合計金額 |
| remarks | String | | 備考 |
| status | String | ✓ | ステータス |
| purchaseOrderId | String | | 関連する発注書ID |
| createdAt | DateTime | ✓ | 作成日時 |
| updatedAt | DateTime | ✓ | 更新日時 |

**発注書との主な違い:**
- `deliveryLocation`（納入場所）フィールドは不要
- ステータスは下書き (draft) と送付済み (sent) の2つのみ
- 関連する発注書IDを持つ（任意）

### 3.2 発注請書明細テーブル (OrderConfirmationItem)
| フィールド名 | 型 | 必須 | 説明 |
|------------|---|-----|------|
| id | String (UUID) | ✓ | 主キー |
| orderConfirmationId | String | ✓ | 発注請書ID |
| name | String | ✓ | 項目名 |
| quantity | Decimal | ✓ | 数量 |
| unit | String | | 単位 |
| unitPrice | Decimal | ✓ | 単価 |
| taxType | String | ✓ | 税区分（taxable/non-taxable/tax-included） |
| taxRate | Int | | 税率（8/10/0） |
| amount | Decimal | ✓ | 金額 |
| remarks | String | | 備考 |
| displayOrder | Int | ✓ | 表示順 |
| createdAt | DateTime | ✓ | 作成日時 |
| updatedAt | DateTime | ✓ | 更新日時 |

## 4. API仕様

### 4.1 エンドポイント一覧
| メソッド | パス | 説明 |
|---------|-----|------|
| GET | /api/order-confirmations | 発注請書一覧取得 |
| POST | /api/order-confirmations | 発注請書新規作成 |
| GET | /api/order-confirmations/[id] | 発注請書詳細取得 |
| PUT | /api/order-confirmations/[id] | 発注請書更新 |
| DELETE | /api/order-confirmations/[id] | 発注請書削除 |
| POST | /api/order-confirmations/[id]/duplicate | 発注請書複製 |
| GET | /api/order-confirmations/[id]/pdf | PDF生成・ダウンロード |
| PUT | /api/order-confirmations/[id]/status | ステータス更新 |
| POST | /api/order-confirmations/from-purchase-order | 発注書から発注請書作成 |

### 4.2 リクエスト/レスポンス形式
発注書APIと同様のJSON形式を使用

## 5. UI仕様

### 5.1 画面構成
1. **発注請書一覧画面** (/order-confirmations)
   - 発注請書の一覧表示
   - ステータスフィルタ
   - 検索機能
   - ページネーション

2. **発注請書詳細画面** (/order-confirmations/[id])
   - 発注請書内容の表示
   - PDF出力ボタン
   - 編集・複製・削除ボタン（権限に応じて）
   - ステータス変更機能

3. **発注請書作成画面** (/order-confirmations/new)
   - 発注先選択
   - 基本情報入力
   - 明細入力
   - 納期・お支払い条件等の追加情報入力

4. **発注請書編集画面** (/order-confirmations/[id]/edit)
   - 既存発注請書の編集（下書きのみ）

5. **発注書から発注請書作成画面** (/order-confirmations/from-purchase-order)
   - 発注書選択
   - 内容確認・編集
   - 発注請書への変換

### 5.2 入力フィールド
#### 基本情報
- 発注先（セレクトボックス）
- 敬称（テキスト）
- 件名（テキスト）
- 発行日（日付選択）
- **納期**（日付選択）
- **検収完了期間**（テキスト）
- **お支払い条件**（テキスト）
- 関連発注書（セレクトボックス、任意）

#### 明細
- 項目名（テキスト）
- 数量（数値）
- 単位（テキスト）
- 単価（数値）
- 税区分（セレクトボックス）
- 税率（セレクトボックス）
- 金額（自動計算）

#### その他
- 備考（テキストエリア）
- ステータス（セレクトボックス）

**発注書との主な違い:**
- 納入場所フィールドは**削除**

## 6. PDF出力仕様

### 6.1 レイアウト
発注書PDFと同様の基本レイアウトを使用し、以下の変更を適用：

#### ヘッダー部
- タイトル：「注　文　請　書」（発注書の「発　注　書」から変更）
- 右上：発行日、発注請書番号

#### 本文部
- **左側**：発注先情報（顧客情報）
  - 会社名
  - 敬称
- **右側の相手方情報は削除**（発注書PDFにある発注先の住所、電話番号、FAX番号などの詳細情報を削除）

#### メッセージ
- 「下記の通り注文承りました。」（発注書の「下記の通り発注申し上げます。」から変更）

#### 概要セクション
- 件名
- 納期
- 検収完了期間
- **納入場所：削除**（発注書から削除）
- 「ご注文金額：」（発注書の「ご発注金額：」から変更）

#### お支払い条件
- お支払い条件（発注書と同様）

#### 明細テーブル
- 発注書と同様の形式

#### フッター
- 小計・税額・合計金額
- 備考欄

### 6.2 出力形式
- A4サイズ
- 日本語フォント対応（Noto Sans JP）
- カラー印刷対応

### 6.3 PDF出力の主な変更点まとめ
| 項目 | 発注書 | 発注請書 |
|-----|-------|---------|
| タイトル | 発　注　書 | 注　文　請　書 |
| メッセージ | 下記の通り発注申し上げます。 | 下記の通り注文承りました。 |
| 金額ラベル | ご発注金額： | ご注文金額： |
| 右側の相手方情報 | 表示（住所、TEL、FAX等） | **削除（非表示）** |
| 納入場所 | 表示 | **削除（非表示）** |

## 7. バリデーション

### 7.1 入力値検証
- 発注先：必須、存在チェック
- 件名：必須、最大100文字
- 発行日：必須、日付形式
- 納期：任意、日付形式、発行日以降
- 検収完了期間：任意、最大100文字
- お支払い条件：任意、最大500文字
- 明細：最低1件必須
- 数量：必須、正の数
- 単価：必須、0以上
- 金額：自動計算、編集不可

### 7.2 ビジネスルール
- 発注請書番号は自動採番（重複不可）
- 送付済み以降のステータスでは編集不可
- 削除は下書きステータスのみ可能
- ステータスは下書き→送付済みへの遷移のみ許可

## 8. セキュリティ要件

### 8.1 アクセス制御
- 認証済みユーザーのみアクセス可能
- 作成者と管理者のみ編集・削除可能
- 全ユーザーが閲覧可能

### 8.2 データ保護
- SQLインジェクション対策
- XSS対策
- CSRF対策

## 9. パフォーマンス要件
- 一覧表示：最大100件/ページ
- PDF生成：5秒以内
- 検索レスポンス：2秒以内

## 10. メニュー構成
発注請書管理は、書類管理メニュー内の発注書管理の下に追加：

```
書類管理
├── 見積書管理
├── 発注書管理
├── 発注請書管理  ← 新規追加
└── 請求書管理
```

## 11. 実装時の注意点

### 11.1 発注書管理との共通点
- 基本的な画面構成・レイアウトは発注書管理を踏襲
- データモデルの構造も発注書とほぼ同じ
- API設計も発注書管理を参考にする

### 11.2 コードの共通化方針
発注書管理と発注請書管理は機能的に類似しているため、以下の方針で共通化を図ります：

#### 共通化対象
1. **フォームコンポーネント**
   - 明細入力フォーム（品名、数量、単位、単価、税率、金額）
   - 税計算ロジック（小計・消費税・合計金額の計算）
   - 端数処理ロジック
   - 敬称入力フィールド
   - 件名、発行日、納期、検収完了期間、お支払い条件などの基本情報入力

2. **バリデーション**
   - 明細の入力検証（数量、単価、金額の妥当性チェック）
   - 日付の妥当性チェック
   - 必須項目チェック

3. **ユーティリティ関数**
   - 通貨フォーマット関数
   - 日付フォーマット関数
   - 税額計算関数
   - 番号自動採番ロジック

4. **API設計パターン**
   - CRUD操作の基本構造
   - エラーハンドリング
   - レスポンス形式

5. **型定義**
   - 明細アイテムの型
   - ステータスの型（発注請書は draft/sent のみだが、基本構造は共通）
   - 税区分の型

#### 実装方法
1. **共通コンポーネントの作成**
   - `components/documents/common/` 配下に共通コンポーネントを配置
   - `DocumentItemForm`: 明細入力フォーム
   - `DocumentBasicInfo`: 基本情報入力フォーム
   - `DocumentSummary`: 小計・税額・合計表示

2. **共通フックの作成**
   - `hooks/useDocumentCalculation`: 税計算・合計計算ロジック
   - `hooks/useDocumentValidation`: バリデーションロジック

3. **共通ユーティリティの作成**
   - `lib/document-utils.ts`: 通貨・日付フォーマット、番号採番など

4. **型定義の共有**
   - `types/document.ts`: 共通の型定義

#### 差分の吸収方法
- `documentType` パラメータで発注書と発注請書を区別
- 条件分岐で以下の差分を吸収：
  - 納入場所フィールドの表示/非表示
  - ステータスの選択肢
  - PDF生成時のタイトル・メッセージ
  - API エンドポイント

#### 期待される効果
- コード量の削減（推定30-40%削減）
- 保守性の向上（バグ修正や機能追加が両方に反映される）
- テストコードの共通化
- 一貫性のあるユーザー体験

### 11.3 発注書管理との相違点
1. **データベース**
   - 新しいテーブル `OrderConfirmation` と `OrderConfirmationItem` を作成
   - `deliveryLocation` フィールドは作成しない
   - 発注請書番号は `YYYY-MM-NNN` 形式を使用（例: 2025-01-001）

2. **PDF生成**
   - タイトル、メッセージ、金額ラベルの文言変更
   - 右側の相手方情報セクションを非表示
   - 納入場所を非表示

3. **画面**
   - 納入場所の入力フィールドを削除
   - ステータスの選択肢を変更（draft, sent の2つのみ）

4. **ルーティング**
   - `/order-confirmations/*` パスを使用

## 12. 今後の拡張予定
- 承認ワークフロー機能
- 発注請書テンプレート機能
- 自動メール送信機能
- 発注書との自動連携・突合機能
- 電子署名対応
- 発注書からの一括変換機能

## 13. 参考資料
- 発注書管理機能仕様書（11_purchase_orders.md）
- 見積書管理機能仕様書（08_estimates.md）
- 請求書管理機能仕様書（09_invoices.md）
