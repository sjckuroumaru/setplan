// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザーテーブル
model User {
  id              String    @id @default(uuid())
  employeeNumber  String    @unique
  username        String    @unique
  email           String    @unique
  password        String
  lastName        String
  firstName       String
  department      String?   // 使用しない（後方互換性のため残す）
  departmentId    String?   // 部署・チームID
  isAdmin         Boolean   @default(false)
  status          String    @default("active") // active, inactive
  sealImagePath   String?   // 担当者印画像パス
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  departmentRef      Department? @relation(fields: [departmentId], references: [id])
  dailySchedules     DailySchedule[]
  issues             Issue[]
  assignedIssues     Issue[]    @relation("AssignedUser")
  comments           Comment[]
  estimates          Estimate[]
  invoices           Invoice[]
  purchaseOrders     PurchaseOrder[]
  orderConfirmations OrderConfirmation[]
  deliveryNotes      DeliveryNote[]

  @@map("users")
}

// プロジェクトテーブル
model Project {
  id               String    @id @default(uuid())
  projectNumber    String    @unique
  projectName      String
  description      String?
  status           String    @default("planning") // planning, developing, active, suspended, completed
  plannedStartDate DateTime?
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?
  budget           Decimal?  @db.Decimal(15, 2) // 予算（円）
  hourlyRate       Decimal?  @db.Decimal(10, 2) // 時間単価（円/時間）
  departmentId     String?   // 担当部署・チームID
  purchaseOrderId  String?   // 関連発注書ID
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // 実績台帳用の新規フィールド
  projectType      String?   @default("development") // 種別: development(開発), ses(SES), maintenance(保守), other(その他)
  deliveryDate     DateTime? @db.Date // 納品日
  invoiceableDate  DateTime? @db.Date // 請求可能日
  memo             String?   @db.Text // メモ
  outsourcingCost  Decimal?  @default(0) @db.Decimal(15, 2) // 外注費（円）
  serverDomainCost Decimal?  @default(0) @db.Decimal(15, 2) // サーバー・ドメイン代（円）

  // パフォーマンス最適化：集計値の事前計算
  totalLaborHours  Decimal?  @default(0) @db.Decimal(10, 2) // 総作業時間（実績の合計）
  totalLaborCost   Decimal?  @default(0) @db.Decimal(15, 2) // 総投下工数（円）= totalLaborHours × hourlyRate
  lastCalculatedAt DateTime? // 最終集計日時

  // Relations
  department       Department?    @relation(fields: [departmentId], references: [id])
  purchaseOrder    PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  schedulePlans    SchedulePlan[]
  scheduleActuals  ScheduleActual[]
  issues           Issue[]

  @@map("projects")
}

// 日別基本情報テーブル
model DailySchedule {
  id           String    @id @default(uuid())
  userId       String
  scheduleDate DateTime  @db.Date
  checkInTime  String?   // "09:00" 形式
  checkOutTime String?   // "18:00" 形式
  breakTime    Float     @default(1.0) // 休憩時間（時間単位）
  workLocation String?   // 勤務場所: "office"(出社), "remote"(在宅)、空欄許可
  reflection   String?   @db.Text  // 所感
  status       String    @default("planned") // planned, in_progress, completed
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user         User      @relation(fields: [userId], references: [id])
  plans        SchedulePlan[]
  actuals      ScheduleActual[]

  @@unique([userId, scheduleDate])
  @@map("daily_schedules")
}

// 予定項目テーブル
model SchedulePlan {
  id            String        @id @default(uuid())
  scheduleId    String
  projectId     String?       // プロジェクト関連の場合
  content       String        // 予定内容
  details       String?       @db.Text
  displayOrder  Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  schedule      DailySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  project       Project?      @relation(fields: [projectId], references: [id])

  @@map("schedule_plans")
}

// 実績項目テーブル
model ScheduleActual {
  id            String        @id @default(uuid())
  scheduleId    String
  projectId     String?       // プロジェクト関連の場合
  content       String        // 実績内容
  hours         Float         // 実績時間
  details       String?       @db.Text
  displayOrder  Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  schedule      DailySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  project       Project?      @relation(fields: [projectId], references: [id])

  @@map("schedule_actuals")
}

// 課題管理テーブル
model Issue {
  id              String    @id @default(uuid())
  projectId       String
  title           String
  description     String    @db.Text
  status          String    @default("open") // open, in_progress, resolved, closed
  priority        String    @default("medium") // low, medium, high, critical
  category        String?   // bug, feature, improvement, task
  reporterId      String
  assigneeId      String?
  dueDate         DateTime?
  resolvedAt      DateTime?
  
  // ガントチャート用フィールド
  startDate       DateTime?
  endDate         DateTime?
  progress        Int       @default(0)
  dependencies    String?   @db.Text // JSON配列形式で依存タスクIDを格納
  parentIssueId   String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project         Project   @relation(fields: [projectId], references: [id])
  reporter        User      @relation(fields: [reporterId], references: [id])
  assignee        User?     @relation("AssignedUser", fields: [assigneeId], references: [id])
  parentIssue     Issue?    @relation("IssueHierarchy", fields: [parentIssueId], references: [id])
  childIssues     Issue[]   @relation("IssueHierarchy")
  comments        Comment[]

  @@map("issues")
}

// コメントテーブル
model Comment {
  id          String    @id @default(uuid())
  issueId     String
  userId      String
  content     String    @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  issue       Issue     @relation(fields: [issueId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@map("comments")
}

// 自社情報テーブル
model Company {
  id                      String    @id @default(uuid())
  name                    String
  postalCode              String?
  address                 String?
  building                String?
  representative          String?
  phone                   String?
  fax                     String?
  remarks                 String?   @db.Text
  sealImagePath           String?   // 会社印画像パス
  // 請求書用追加フィールド
  qualifiedInvoiceNumber  String?   // 適格請求書発行事業者登録番号（例: "T1234567890123"）
  bankName                String?   // 銀行名
  branchName              String?   // 支店名
  accountType             String?   // 口座種別（普通/当座）
  accountNumber           String?   // 口座番号
  accountHolder           String?   // 口座名義
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@map("companies")
}

// 顧客テーブル
model Customer {
  id              String    @id @default(uuid())
  name            String
  postalCode      String?
  address         String?
  building        String?
  representative  String?
  phone           String?
  fax             String?
  remarks         String?   @db.Text
  status          String    @default("active") // active, inactive
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  estimates          Estimate[]
  invoices           Invoice[]
  purchaseOrders     PurchaseOrder[]
  orderConfirmations OrderConfirmation[] @relation("OrderConfirmationSupplier")
  deliveryNotes      DeliveryNote[]

  @@map("customers")
}

// 見積書テーブル
model Estimate {
  id              String    @id @default(uuid())
  estimateNumber  String    @unique
  customerId      String
  honorific       String    @default("御中")
  subject         String
  issueDate       DateTime  @default(now())
  validUntil      DateTime
  userId          String
  taxType         String    @default("exclusive") // inclusive(税込), exclusive(税別)
  taxRate         Int       @default(10)
  roundingType    String    @default("floor") // floor(切り捨て), ceil(切り上げ), round(四捨五入)
  subtotal        Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal   @default(0) @db.Decimal(15, 2)
  totalAmount     Decimal   @default(0) @db.Decimal(15, 2)
  remarks         String?   @db.Text
  status          String    @default("draft") // draft, sent, accepted, rejected, expired
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  customer        Customer  @relation(fields: [customerId], references: [id])
  user            User      @relation(fields: [userId], references: [id])
  items           EstimateItem[]
  invoice         Invoice?  // 変換後の請求書
  deliveryNote    DeliveryNote? // 変換後の納品書

  @@map("estimates")
}

// 見積明細テーブル
model EstimateItem {
  id              String    @id @default(uuid())
  estimateId      String
  name            String
  quantity        Decimal   @default(1) @db.Decimal(10, 2)
  unit            String?
  unitPrice       Decimal   @default(0) @db.Decimal(15, 2)
  taxType         String    @default("taxable") // taxable(課税), non-taxable(非課税), tax-included(税込)
  amount          Decimal   @default(0) @db.Decimal(15, 2)
  remarks         String?   @db.Text
  displayOrder    Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  estimate        Estimate  @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  @@map("estimate_items")
}

// 請求書テーブル
model Invoice {
  id              String    @id @default(uuid())
  invoiceNumber   String    @unique
  estimateId      String?   @unique // 元見積書との紐付け（1対1）
  customerId      String
  honorific       String    @default("御中")
  subject         String
  issueDate       DateTime  @default(now())
  dueDate         DateTime
  userId          String
  taxType         String    @default("exclusive") // inclusive(税込), exclusive(税別)
  taxRate         Int       @default(10)
  roundingType    String    @default("floor") // floor(切り捨て), ceil(切り上げ), round(四捨五入)
  subtotal        Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount8      Decimal   @default(0) @db.Decimal(15, 2) // 8%税額
  taxAmount10     Decimal   @default(0) @db.Decimal(15, 2) // 10%税額
  totalAmount     Decimal   @default(0) @db.Decimal(15, 2)
  remarks         String?   @db.Text
  status          String    @default("draft") // draft, sent, paid, overdue, cancelled
  paidAmount      Decimal   @default(0) @db.Decimal(15, 2) // 入金済み金額
  paidDate        DateTime? // 入金日
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  estimate        Estimate? @relation(fields: [estimateId], references: [id])
  customer        Customer  @relation(fields: [customerId], references: [id])
  user            User      @relation(fields: [userId], references: [id])
  items           InvoiceItem[]

  @@map("invoices")
}

// 請求明細テーブル
model InvoiceItem {
  id              String    @id @default(uuid())
  invoiceId       String
  name            String
  quantity        Decimal   @default(1) @db.Decimal(10, 2)
  unit            String?
  unitPrice       Decimal   @default(0) @db.Decimal(15, 2)
  taxType         String    @default("taxable") // taxable(課税), non-taxable(非課税), tax-included(税込)
  taxRate         Int       @default(10) // 8, 10, 0
  amount          Decimal   @default(0) @db.Decimal(15, 2)
  remarks         String?   @db.Text
  displayOrder    Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

// 発注書テーブル
model PurchaseOrder {
  id                String    @id @default(uuid())
  orderNumber       String    @unique
  supplierId        String    // 発注先（顧客テーブル参照）
  honorific         String    @default("御中")
  subject           String
  issueDate         DateTime  @default(now())
  deliveryDate      DateTime? // 納期
  completionPeriod  String?   // 検収完了期間
  deliveryLocation  String?   // 納入場所
  paymentTerms      String?   // お支払い条件
  userId            String
  taxType           String    @default("exclusive") // inclusive(税込), exclusive(税別)
  taxRate           Int       @default(10)
  roundingType      String    @default("floor") // floor(切り捨て), ceil(切り上げ), round(四捨五入)
  subtotal          Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount         Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount8        Decimal   @default(0) @db.Decimal(15, 2) // 8%税額
  taxAmount10       Decimal   @default(0) @db.Decimal(15, 2) // 10%税額
  totalAmount       Decimal   @default(0) @db.Decimal(15, 2)
  remarks           String?   @db.Text
  status            String    @default("draft") // draft, sent, approved, rejected, closed
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  supplier           Customer  @relation(fields: [supplierId], references: [id])
  user               User      @relation(fields: [userId], references: [id])
  items              PurchaseOrderItem[]
  projects           Project[] // 関連案件
  orderConfirmations OrderConfirmation[] @relation("OrderConfirmationPurchaseOrder")

  @@map("purchase_orders")
}

// 発注明細テーブル
model PurchaseOrderItem {
  id                String    @id @default(uuid())
  purchaseOrderId   String
  name              String
  quantity          Decimal   @default(1) @db.Decimal(10, 2)
  unit              String?
  unitPrice         Decimal   @default(0) @db.Decimal(15, 2)
  taxType           String    @default("taxable") // taxable(課税), non-taxable(非課税), tax-included(税込)
  taxRate           Int       @default(10) // 8, 10, 0
  amount            Decimal   @default(0) @db.Decimal(15, 2)
  remarks           String?   @db.Text
  displayOrder      Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}

// 発注請書テーブル
model OrderConfirmation {
  id                String    @id @default(uuid())
  confirmationNumber String    @unique
  supplierId        String    // 発注先（顧客テーブル参照）
  honorific         String    @default("御中")
  subject           String
  issueDate         DateTime  @default(now())
  deliveryDate      DateTime? // 納期
  completionPeriod  String?   // 検収完了期間
  paymentTerms      String?   // お支払い条件
  userId            String
  taxType           String    @default("exclusive") // inclusive(税込), exclusive(税別)
  taxRate           Int       @default(10)
  roundingType      String    @default("floor") // floor(切り捨て), ceil(切り上げ), round(四捨五入)
  subtotal          Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount         Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount8        Decimal   @default(0) @db.Decimal(15, 2) // 8%税額
  taxAmount10       Decimal   @default(0) @db.Decimal(15, 2) // 10%税額
  totalAmount       Decimal   @default(0) @db.Decimal(15, 2)
  remarks           String?   @db.Text
  status            String    @default("draft") // draft, sent
  purchaseOrderId   String?   // 関連する発注書ID
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  supplier          Customer  @relation("OrderConfirmationSupplier", fields: [supplierId], references: [id])
  user              User      @relation(fields: [userId], references: [id])
  items             OrderConfirmationItem[]
  purchaseOrder     PurchaseOrder? @relation("OrderConfirmationPurchaseOrder", fields: [purchaseOrderId], references: [id])

  @@map("order_confirmations")
}

// 発注請書明細テーブル
model OrderConfirmationItem {
  id                    String    @id @default(uuid())
  orderConfirmationId   String
  name                  String
  quantity              Decimal   @default(1) @db.Decimal(10, 2)
  unit                  String?
  unitPrice             Decimal   @default(0) @db.Decimal(15, 2)
  taxType               String    @default("taxable") // taxable(課税), non-taxable(非課税), tax-included(税込)
  taxRate               Int       @default(10) // 8, 10, 0
  amount                Decimal   @default(0) @db.Decimal(15, 2)
  remarks               String?   @db.Text
  displayOrder          Int       @default(0)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  orderConfirmation     OrderConfirmation @relation(fields: [orderConfirmationId], references: [id], onDelete: Cascade)

  @@map("order_confirmation_items")
}

// 納品書テーブル
model DeliveryNote {
  id                    String    @id @default(uuid())
  deliveryNoteNumber    String    @unique
  estimateId            String?   @unique // 元見積書との紐付け（1対1）
  customerId            String
  honorific             String    @default("御中")
  subject               String
  deliveryDate          DateTime  @default(now())
  userId                String
  taxType               String    @default("exclusive") // inclusive(税込), exclusive(税別)
  taxRate               Int       @default(10)
  roundingType          String    @default("floor") // floor(切り捨て), ceil(切り上げ), round(四捨五入)
  subtotal              Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount             Decimal   @default(0) @db.Decimal(15, 2)
  taxAmount8            Decimal   @default(0) @db.Decimal(15, 2) // 8%税額
  taxAmount10           Decimal   @default(0) @db.Decimal(15, 2) // 10%税額
  totalAmount           Decimal   @default(0) @db.Decimal(15, 2)
  remarks               String?   @db.Text
  status                String    @default("draft") // draft, sent
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  estimate              Estimate? @relation(fields: [estimateId], references: [id])
  customer              Customer  @relation(fields: [customerId], references: [id])
  user                  User      @relation(fields: [userId], references: [id])
  items                 DeliveryNoteItem[]

  @@map("delivery_notes")
}

// 納品明細テーブル
model DeliveryNoteItem {
  id              String    @id @default(uuid())
  deliveryNoteId  String
  name            String
  quantity        Decimal   @default(1) @db.Decimal(10, 2)
  unit            String?
  unitPrice       Decimal   @default(0) @db.Decimal(15, 2)
  taxType         String    @default("taxable") // taxable(課税), non-taxable(非課税), tax-included(税込)
  taxRate         Int       @default(10) // 8, 10, 0
  amount          Decimal   @default(0) @db.Decimal(15, 2)
  remarks         String?   @db.Text
  displayOrder    Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  deliveryNote    DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)

  @@map("delivery_note_items")
}

// 部署・チームテーブル
model Department {
  id        String    @id @default(uuid())
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  users     User[]
  projects  Project[]

  @@map("departments")
}
